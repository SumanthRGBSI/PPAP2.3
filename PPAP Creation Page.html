<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced PPAP Creation Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // ... existing tailwind.config ...
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: { '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd', '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8', '800': '#1e40af', '900': '#1e3a8a' },
                        success: { '50': '#f0fdf4', '100': '#dcfce7', '200': '#bbf7d0', '300': '#86efac', '400': '#4ade80', '500': '#22c55e', '600': '#16a34a', '700': '#15803d', '800': '#166534', '900': '#14532d' },
                        danger: { '50': '#fef2f2', '100': '#fee2e2', '200': '#fecaca', '300': '#fca5a5', '400': '#f87171', '500': '#ef4444', '600': '#dc2626', '700': '#b91c1c', '800': '#991b1b', '900': '#7f1d1d' },
                        warning: { '50': '#fffbeb', '100': '#fef3c7', '200': '#fde68a', '300': '#fcd34d', '400': '#fbbf24', '500': '#f59e0b', '600': '#d97706', '700': '#b45309', '800': '#92400e', '900': '#78350f' },
                        info: { '50': '#eef2ff', '100': '#e0e7ff', '200': '#c7d2fe', '300': '#a5b4fc', '400': '#818cf8', '500': '#6366f1', '600': '#4f46e5', '700': '#4338ca', '800': '#3730a3', '900': '#312e81' },
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .card { background-color: white; border-radius: 1rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); overflow: hidden; }
        *:focus-visible { outline: 2px solid #3b82f6 !important; outline-offset: 2px; border-radius: 0.375rem; }
        
        .submission-btn {
            background-color: #f8fafc; color: #475569; border: 1px solid #e2e8f0;
            transition: all 0.2s ease-in-out; padding: 0.375rem 0.875rem; font-size: 0.875rem; 
            border-radius: 0.5rem; display: flex; align-items: center; gap: 0.375rem;
        }
        .submission-btn:hover:not(.active) { background-color: #f1f5f9; border-color: #cbd5e1; }
        .submission-btn i { display: none; }
        .submission-btn.active i { display: inline-block; }
        .submission-btn.active.not-required { border-color: #fca5a5; color: #b91c1c; background-color: #fee2e2; }
        .submission-btn.active.required { border-color: #86efac; color: #15803d; background-color: #dcfce7; }
        .submission-btn.active.as-requested { border-color: #93c5fd; color: #1d4ed8; background-color: #dbeafe; }
        .submission-btn.active.if-applicable { border-color: #fcd34d; color: #b45309; background-color: #fef3c7; }

        .phase-header > td { color: #2563eb; font-weight: 600; border-bottom: 1px solid #e2e8f0; background-color: #f8fafc; }
        .phase-summary span { font-size: 0.875rem; }
        .phase-summary .font-bold { font-weight: 700; }

        .phase-summary .summary-tag { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.125rem 0.625rem; border-radius: 9999px; font-weight: 600; font-size: 0.75rem; line-height: 1.2; }
        .phase-summary .summary-tag-r { background-color: #dcfce7; color: #166534; }
        .phase-summary .summary-tag-nr { background-color: #fee2e2; color: #991b1b; }
        .phase-summary .summary-tag-ar { background-color: #dbeafe; color: #1e40af; }
        .phase-summary .summary-tag-ia { background-color: #fef3c7; color: #92400e; }

        .details-row.hidden { display: none; }
        .details-row > td { padding: 0 !important; }
        .checklist-details { background-color: #f8fafc; padding: 1rem 1.5rem 1.5rem 4.5rem; }
        .checklist-item { display: flex; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item label { cursor: not-allowed; }

        #options-content {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
            padding-top: 0; padding-bottom: 0;
        }
        #options-content.expanded { max-height: 500px; padding-top: 1.25rem; padding-bottom: 1.25rem; }
        #options-toggle .chevron-icon { transition: transform 0.3s ease-out; }
        #options-toggle.expanded .chevron-icon { transform: rotate(180deg); }


        .datepicker { display: none; position: absolute; z-index: 50; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); width: 360px; padding: 0.5rem; }
        .datepicker.active { display: block; }
        .datepicker-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; }
        .datepicker-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 1px; }
        .datepicker-grid > div { display: flex; justify-content: center; align-items: center; height: 36px; font-size: 0.875rem; cursor: pointer; border-radius: 0.375rem; transition: background-color 0.2s; }
        .datepicker-day-name, .datepicker-week { color: #6b7280; font-weight: 500; font-size: 0.75rem; cursor: default !important; }
        .datepicker-week { background-color: #f9fafb; }
        .datepicker-day:not(.disabled):hover { background-color: #eff6ff; }
        .datepicker-day.selected { background-color: #3b82f6; color: white; font-weight: 600; }
        .datepicker-day.disabled { color: #d1d5db; cursor: default; }
        .datepicker-day.today { border: 1px solid #3b82f6; }

        .search-results-dropdown {
             max-height: 200px;
             overflow-y: auto;
        }
        
        .checklist-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
        }
        .checklist-tag i {
            color: #64748b; /* slate-500 */
        }
        .expandable-row {
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <header class="bg-white/90 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between py-3">
                <a href="./index.html" class="flex items-center gap-2" title="Back to Hub">
                    <span class="inline-flex h-8 w-8 rounded-lg bg-primary-600 text-white items-center justify-center font-extrabold">P</span>
                    <span class="text-sm font-semibold text-gray-900">PPAP Hub</span>
                </a>
                <nav class="flex items-center gap-1">
                    <a href="./PPAP Creation Page.html" class="px-3 py-2 text-sm font-medium rounded-md bg-primary-600 text-white hover:bg-primary-700">Creation</a>
                    <a href="./PPAP View Page.html" class="px-3 py-2 text-sm font-medium rounded-md text-slate-700 hover:text-primary-700 hover:bg-primary-50">View</a>
                    <a href="./Bulk Submit.html" class="px-3 py-2 text-sm font-medium rounded-md text-slate-700 hover:text-primary-700 hover:bg-primary-50">Bulk Submit</a>
                </nav>
            </div>
        </div>
    </header>
    <div class="max-w-screen-2xl mx-auto">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Create New PPAP Request</h1>
            <p class="text-slate-500 mt-1">Complete the form to initiate the Production Part Approval Process.</p>
        </header>

        <!-- Main Layout Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            
            <!-- Left Column: Scrollable Content -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Part & Submission Details Card -->
                 <div class="card">
                    <div class="p-5 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 flex items-center"><i class="fas fa-box-open text-primary-500 mr-3 fa-fw"></i>Part & Submission Details</h3>
                    </div>
                    <div class="p-5 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                        <h4 class="md:col-span-3 text-sm font-semibold text-gray-500 uppercase tracking-wider pb-2 border-b">Part Information</h4>
                        <div><label class="block text-sm font-medium text-gray-600 mb-1">PPAP ID</label><input type="text" value="PPAP-SPLR-2025-XXXXX" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly></div>
                        <div><label class="block text-sm font-medium text-gray-600 mb-1">Part <span class="text-red-500">*</span></label><button class="w-full text-left p-2 border border-gray-300 rounded-lg hover:border-primary-500 flex justify-between items-center mandatory-field" data-field-type="button"><span>Choose Part</span> <i class="fas fa-search text-gray-400"></i></button></div>
                        <div><label class="block text-sm font-medium text-gray-600 mb-1">Part Revision</label><input type="text" placeholder="Auto-populated" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" readonly></div>
                        <div><label class="block text-sm font-medium text-gray-600 mb-1">Part Classification</label><input type="text" placeholder="Auto-populated" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" readonly></div>
                        <div><label class="block text-sm font-medium text-gray-600 mb-1">Customer Part Number</label><input type="text" placeholder="Enter number" class="w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-gray-600 mb-1">Customer Division</label><input type="text" placeholder="Enter division" class="w-full p-2 border border-gray-300 rounded-lg"></div>
                        
                        <h4 class="md:col-span-3 text-sm font-semibold text-gray-500 uppercase tracking-wider pb-2 border-b pt-3">Supplier Information</h4>
                        <div class="md:col-span-3"><label class="block text-sm font-medium text-gray-600 mb-1">Supplier <span class="text-red-500">*</span></label><button class="w-full text-left p-2 border border-gray-300 rounded-lg hover:border-primary-500 flex justify-between items-center mandatory-field" data-field-type="button"><span>Choose Supplier</span><i class="fas fa-user-tie text-gray-400"></i></button></div>
                        <div><label class="block text-sm font-medium text-gray-600 mb-1">Location</label><select class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" disabled><option>Select Location</option></select></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-600 mb-1">Plant</label><select class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" disabled><option>Select Plant</option></select></div>

                        <h4 class="md:col-span-3 text-sm font-semibold text-gray-500 uppercase tracking-wider pb-2 border-b pt-3">Submission Information</h4>
                        <div><label class="block text-sm font-medium text-gray-600 mb-1">Request Creation Date</label><input type="text" value="06 Sep 2025" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-600 mb-1">Program <span class="text-red-500">*</span></label><input type="text" placeholder="Enter Program Name" class="w-full p-2 border border-gray-300 rounded-lg mandatory-field"></div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Target Submission Date <span class="text-red-500">*</span></label>
                            <div class="relative datepicker-trigger bg-white w-full p-2 pl-10 border border-gray-300 rounded-lg cursor-pointer flex justify-between items-center">
                                <i class="fas fa-calendar-alt absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <span class="date-display text-gray-500">Select date</span>
                                <span class="week-tag hidden bg-primary-100 text-primary-700 text-xs font-semibold px-2 py-0.5 rounded-full"></span>
                                <input type="hidden" class="date-input mandatory-field">
                            </div>
                        </div>
                        <div>
                             <label class="block text-sm font-medium text-gray-600 mb-1">Approval Date <span class="text-red-500">*</span></label>
                             <div class="relative datepicker-trigger bg-white w-full p-2 pl-10 border border-gray-300 rounded-lg cursor-pointer flex justify-between items-center">
                                <i class="fas fa-calendar-check absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <span class="date-display text-gray-500">Select date</span>
                                <span class="week-tag hidden bg-primary-100 text-primary-700 text-xs font-semibold px-2 py-0.5 rounded-full"></span>
                                <input type="hidden" class="date-input mandatory-field">
                            </div>
                        </div>
                         <div><label class="block text-sm font-medium text-gray-600 mb-1">Submission Level <span class="text-red-500">*</span></label><select class="w-full p-2 border border-gray-300 rounded-lg mandatory-field"><option value="">Select Level...</option><option>Level 3 - Full Submission</option></select></div>
                        <div class="md:col-span-3"><label class="block text-sm font-medium text-gray-600 mb-1">Template <span class="text-red-500">*</span></label><select class="w-full p-2 border border-gray-300 rounded-lg mandatory-field"><option value="">Select Template...</option><option>Standard Automotive Template</option></select></div>
                        <div class="md:col-span-3"><label class="block text-sm font-medium text-gray-600 mb-1">PPAP Reason</label><input type="text" placeholder="Enter reason for PPAP" class="w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div class="md:col-span-3"><label class="block text-sm font-medium text-gray-600 mb-1">Description <span class="text-red-500">*</span></label><textarea rows="2" placeholder="Provide a detailed description..." class="w-full p-2 border border-gray-300 rounded-lg mandatory-field"></textarea></div>
                    </div>
                </div>

                <!-- PPAP Submission Requirements Card -->
                 <div class="card" id="requirements-card">
                    <div class="p-5 border-b border-gray-200 sticky top-0 bg-white/80 backdrop-blur-sm z-10">
                        <div class="flex flex-wrap justify-between items-center gap-4">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center"><i class="fas fa-tasks text-primary-500 mr-3 fa-fw"></i>PPAP Submission Requirements</h3>
                            <div class="flex items-center gap-2">
                                <button id="expand-all-btn" class="text-xs px-3 py-1 bg-white border rounded-md text-gray-600 hover:bg-gray-50">Expand All</button>
                                <button id="collapse-all-btn" class="text-xs px-3 py-1 bg-white border rounded-md text-gray-600 hover:bg-gray-50">Collapse All</button>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left" id="requirements-table">
                             <tbody>
                                <!-- Content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Sticky Sidebar -->
            <div class="lg:col-span-4 lg:sticky top-6">
                <div class="space-y-6">
                    <!-- Overall Form Progress Tracker -->
                    <div class="card">
                        <div class="p-5">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-base font-semibold text-primary-700">Overall Form Progress</span>
                                <span id="overall-progress-text" class="text-sm font-semibold text-primary-700">0 of 0 mandatory fields complete</span>
                            </div>
                            <div class="w-full bg-primary-100 rounded-full h-2.5">
                                <div id="overall-progress-bar" class="bg-primary-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- REORDERED & COLLAPSIBLE: Options Card -->
                    <div class="card">
                        <div id="options-toggle" class="p-5 border-b flex justify-between items-center cursor-pointer">
                           <h3 class="text-xl font-semibold text-gray-800 flex items-center"><i class="fas fa-cogs text-primary-500 mr-3 fa-fw"></i>Configuration</h3>
                           <i class="fas fa-chevron-down chevron-icon"></i>
                        </div>
                        <div id="options-content">
                            <div class="p-5 pt-0 space-y-3">
                                <div class="flex items-center justify-between p-3 bg-white rounded-lg border"><span class="text-sm font-medium text-gray-700">Individual Approver Sign Off</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div></label></div>
                                <div class="flex items-center justify-between p-3 bg-white rounded-lg border"><span class="text-sm font-medium text-gray-700">Annual Validation</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" class="sr-only peer" checked><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div></label></div>
                            </div>
                        </div>
                    </div>

                    <!-- Team & Assignments Card -->
                    <div class="card" style="max-height: calc(100vh - 18rem); display: flex; flex-direction: column;">
                        <div class="p-5 border-b">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center"><i class="fas fa-users text-primary-500 mr-3 fa-fw"></i>Team & Assignments</h3>
                        </div>
                        <div class="p-5 space-y-4 flex-grow overflow-y-auto">
                            <div><label class="block text-sm font-medium text-gray-600 mb-2">Submission Responsible (Buyer)</label><select class="w-full p-2 border border-gray-300 rounded-lg"><option>Select Buyer...</option></select></div>
                            <hr/>
                            <div id="approvers-section" class="mandatory-field" data-field-type="user-list">
                                <label class="block text-sm font-medium text-gray-600 mb-2">Approvers <span class="text-red-500">*</span></label>
                                <div class="relative user-search-container">
                                    <div class="relative">
                                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <input type="text" placeholder="Search to add approvers..." class="w-full p-2 pl-10 border border-gray-300 rounded-lg user-search-input">
                                    </div>
                                    <div class="absolute top-full left-0 right-0 z-20 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg search-results-dropdown hidden"></div>
                                </div>
                                <div class="space-y-2 user-list mt-3">
                                    <div class="p-2.5 bg-gray-50 rounded-lg flex items-center justify-between"><div class="flex items-center gap-2"><img src="https://placehold.co/32x32/dbeafe/1e40af?text=JS" class="rounded-full"><div><p class="font-semibold text-sm">John Smith</p><p class="text-xs text-gray-500 user-email">j.smith@supplier.com</p></div></div><button class="text-gray-400 hover:text-red-500 remove-user-btn"><i class="fas fa-times"></i></button></div>
                                    <div class="p-2.5 bg-gray-50 rounded-lg flex items-center justify-between"><div class="flex items-center gap-2"><img src="https://placehold.co/32x32/dbeafe/1e40af?text=LW" class="rounded-full"><div><p class="font-semibold text-sm">Laura Williams</p><p class="text-xs text-gray-500 user-email">l.w@supplier.com</p></div></div><button class="text-gray-400 hover:text-red-500 remove-user-btn"><i class="fas fa-times"></i></button></div>
                                </div>
                            </div>
                            <hr/>
                             <div id="reviewers-section" class="mandatory-field" data-field-type="user-list">
                                <label class="block text-sm font-medium text-gray-600 mb-2">PPAP Reviewers <span class="text-red-500">*</span></label>
                                <div class="relative user-search-container">
                                    <div class="relative">
                                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <input type="text" placeholder="Search to add reviewers..." class="w-full p-2 pl-10 border border-gray-300 rounded-lg user-search-input">
                                    </div>
                                    <div class="absolute top-full left-0 right-0 z-20 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg search-results-dropdown hidden"></div>
                                </div>
                                <div class="space-y-2 user-list mt-3">
                                    <div class="p-2.5 bg-gray-50 rounded-lg flex items-center justify-between"><div class="flex items-center gap-2"><img src="https://placehold.co/32x32/dbeafe/1e40af?text=AD" class="rounded-full"><div><p class="font-semibold text-sm">Alice Doe</p><p class="text-xs text-gray-500 user-email">a.doe@customer.com</p></div></div><button class="text-gray-400 hover:text-red-500 remove-user-btn"><i class="fas fa-times"></i></button></div>
                                </div>
                            </div>
                            <hr/>
                             <div id="coordinators-section">
                                <label class="block text-sm font-medium text-gray-600 mb-2">Supplier Coordinators</label>
                                 <div class="relative user-search-container">
                                    <div class="relative">
                                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <input type="text" placeholder="Search to add coordinators..." class="w-full p-2 pl-10 border border-gray-300 rounded-lg user-search-input">
                                    </div>
                                    <div class="absolute top-full left-0 right-0 z-20 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg search-results-dropdown hidden"></div>
                                </div>
                                <div class="space-y-2 user-list mt-3">
                                    <div class="p-2.5 bg-gray-50 rounded-lg flex items-center justify-between"><div class="flex items-center gap-2"><img src="https://placehold.co/32x32/dbeafe/1e40af?text=MB" class="rounded-full"><div><p class="font-semibold text-sm">Mike Brown</p><p class="text-xs text-gray-500 user-email">m.b@supplier.com</p></div></div><button class="text-gray-400 hover:text-red-500 remove-user-btn"><i class="fas fa-times"></i></button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons: Sticky Footer -->
        <footer class="mt-6 p-4 flex justify-between items-center border-t border-gray-200 gap-3 sticky bottom-0 bg-white/80 backdrop-blur-sm rounded-lg shadow-sm">
             <a href="./index.html" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold flex items-center gap-2" title="Back to Hub"><i class="fas fa-arrow-left"></i> Back to Hub</a>
             <div class="flex items-center gap-3">
               <button class="px-5 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold">Save Draft</button>
               <button class="px-5 py-2 bg-success-600 text-white rounded-lg hover:bg-success-700 font-semibold shadow-md shadow-success-500/20 flex items-center gap-2"><i class="fas fa-check-circle"></i> Submit PPAP Request</button>
             </div>
        </footer>
    </div>

    <!-- Datepicker element -->
    <div id="datepicker-container" class="datepicker"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const requirementsData = [
                { phase: "Phase 1 – Planning & Definition", items: [
                    { id: 1, name: "Design Records (Preliminary)", checklist: ["All preliminary CAD models uploaded and linked.", "Preliminary drawings reviewed for critical dimensions."], default: "required" }, { id: 2, name: "Authorized Engineering Changes", checklist: ["ECN/ECR documents attached."], default: "if-applicable" }, { id: 3, name: "Customer Engineering Approval", checklist: ["Signed approval form from customer is attached."], default: "required" }, { id: 4, name: "DFMEA (initial draft)", checklist: ["Initial DFMEA document is created and attached."], default: "required" }, { id: 5, name: "Process Flow Diagram (conceptual)", checklist: ["Conceptual process flow diagram is attached."], default: "required" },
                ]},
                { phase: "Phase 2 – Design & Development", items: [
                    { id: 6, name: "Updated DFMEA", checklist: ["DFMEA is updated based on new information."], default: "required" }, { id: 7, name: "Preliminary PFMEA (draft)", checklist: ["Draft PFMEA is attached."], default: "required" }, { id: 8, name: "Draft Control Plan (prototype)", checklist: ["Prototype Control Plan is attached."], default: "required" }, { id: 9, name: "Material & Performance Test Plan", checklist: ["Test plan document is attached."], default: "required" }, { id: 10, name: "Preliminary MSA Plan", checklist: ["MSA plan (gage strategy) is defined."], default: "required" },
                ]},
                { phase: "Phase 3 – Process Design & Development", items: [
                     { id: 11, name: "Finalized PFMEA", checklist: ["Final PFMEA document attached."], default: "required" }, { id: 12, name: "Control Plan (Pre-launch)", checklist: ["Pre-launch Control Plan is attached."], default: "required" }, { id: 13, name: "Gage R&R / MSA Studies (initial)", checklist: ["Initial MSA studies are complete and results attached."], default: "required" }, { id: 14, name: "Dimensional Results (preliminary)", checklist: ["Preliminary dimensional results attached."], default: "required" }, { id: 15, name: "Material Test Reports (trial runs)", checklist: ["Material test reports from trial runs are attached."], default: "required" }, { id: 16, name: "SPC Plan defined", checklist: ["Statistical Process Control plan is defined and attached."], default: "required" },
                ]},
                { phase: "Phase 4 – Product & Process Validation", items: [
                    { id: 17, name: "Final PFMEA", checklist: ["Final PFMEA attached."], default: "required" }, { id: 18, name: "Final Control Plan (Production)", checklist: ["Production Control Plan attached."], default: "required" }, { id: 19, name: "MSA Studies (complete)", checklist: ["Complete MSA studies attached."], default: "required" }, { id: 20, name: "Dimensional Results (full layout)", checklist: ["Full dimensional layout results attached."], default: "required" }, { id: 21, name: "Material / Performance Tests", checklist: ["Certified test results attached."], default: "required" }, { id: 22, name: "Initial Process Studies (Cp, Cpk)", checklist: ["Cp, Cpk study results attached."], default: "required" }, { id: 23, name: "Appearance Approval Report", checklist: ["AAR attached if applicable."], default: "if-applicable" }, { id: 24, name: "Checking Aids documentation", checklist: ["Documentation for checking aids attached."], default: "if-applicable" },
                ]},
                { phase: "Phase 5 – Feedback, Assessment & Corrective Action", items: [
                    { id: 25, name: "Master Sample", checklist: ["Master sample retained and documented."], default: "required" }, { id: 26, name: "Customer-Specific Requirements", checklist: ["All customer-specific requirements fulfilled."], default: "required" }, { id: 27, name: "Part Submission Warrant (PSW)", checklist: ["PSW signed-off and attached."], default: "required" }, { id: 28, name: "Ongoing SPC and capability studies", checklist: ["Plan for ongoing studies is in place."], default: "required" }, { id: 29, name: "Lessons Learned / Feedback loop", checklist: ["Lessons learned are documented."], default: "required" },
                ]}
            ];

            const allUsers = [
                { id: 1, name: 'John Smith', email: 'j.smith@supplier.com' },
                { id: 2, name: 'Laura Williams', email: 'l.w@supplier.com' },
                { id: 3, name: 'Alice Doe', email: 'a.doe@customer.com' },
                { id: 4, name: 'Mike Brown', email: 'm.b@supplier.com' },
                { id: 5, name: 'David Jones', email: 'david.jones@customer.com' },
                { id: 6, name: 'Sarah Miller', email: 's.miller@supplier.com' },
                { id: 7, name: 'Chris Wilson', email: 'chris.wilson@customer.com' },
                { id: 8, name: 'Jessica Taylor', email: 'jessica.t@supplier.com' },
                { id: 9, name: 'Robert Clark', email: 'robert.c@customer.com' },
                { id: 10, name: 'Mary Johnson', email: 'mary.j@supplier.com' }
            ];

            function renderRequirementsTable() {
                const tableBody = document.querySelector("#requirements-table tbody");
                let content = '';
                requirementsData.forEach(phaseData => {
                    content += `
                        <tr class="phase-header">
                            <td colspan="2" class="px-6 py-3">${phaseData.phase}</td>
                            <td class="px-6 py-3 text-right phase-summary">
                                <div class="flex items-center justify-end gap-x-3">
                                    <span class="text-slate-600">Total: <span class="font-bold total-count">0</span></span>
                                    <span class="summary-tag summary-tag-r" title="Required">R: <span class="font-bold required-count">0</span></span>
                                    <span class="summary-tag summary-tag-nr" title="Not Required">NR: <span class="font-bold not-required-count">0</span></span>
                                    <span class="summary-tag summary-tag-ar" title="As Requested">AR: <span class="font-bold as-requested-count">0</span></span>
                                    <span class="summary-tag summary-tag-ia" title="If Applicable">IA: <span class="font-bold if-applicable-count">0</span></span>
                                </div>
                            </td>
                        </tr>`;
                    phaseData.items.forEach(item => {
                        content += `
                            <tr class="border-b expandable-row">
                                <td class="px-6 py-4 font-medium text-slate-500">${item.id}</td>
                                <td class="px-6 py-4 font-medium text-gray-900">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-chevron-right text-xs text-gray-400 transition-transform fa-fw"></i>
                                            <span class="element-name">${item.name}</span>
                                        </div>
                                        <div class="checklist-tag">
                                            <i class="fas fa-clipboard-list fa-fw"></i>
                                            <span class="checklist-count font-mono">${item.checklist.length}</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2 submission-btn-group">
                                        <button class="submission-btn required ${item.default === 'required' ? 'active' : ''}"><i class="fas fa-check"></i> Required</button>
                                        <button class="submission-btn not-required ${item.default === 'not-required' ? 'active' : ''}"><i class="fas fa-times"></i> Not Required</button>
                                        <button class="submission-btn as-requested ${item.default === 'as-requested' ? 'active' : ''}"><i class="fas fa-question"></i> As Requested</button>
                                        <button class="submission-btn if-applicable ${item.default === 'if-applicable' ? 'active' : ''}"><i class="fas fa-info"></i> If Applicable</button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="details-row hidden">
                                <td colspan="3">
                                    <div class="checklist-details">
                                        <h4 class="text-sm font-semibold mb-2 text-gray-700">Checklist:</h4>
                                        ${item.checklist.map(check => `<label class="checklist-item"><input type="checkbox" disabled class="h-4 w-4 rounded border-gray-300 mr-3"> ${check}</label>`).join('')}
                                    </div>
                                </td>
                            </tr>`;
                    });
                });
                tableBody.innerHTML = content;
            }

            function initializeApp() {
                renderRequirementsTable();
                updatePhaseSummaries();
                attachAllEventListeners();
                updateOverallFormProgress();
            }

            function updatePhaseSummaries() {
                document.querySelectorAll('.phase-header').forEach((headerRow) => {
                    let elements = [];
                    let nextSibling = headerRow.nextElementSibling;
                    while(nextSibling && !nextSibling.classList.contains('phase-header')) {
                        if (nextSibling.classList.contains('expandable-row')) {
                            elements.push(nextSibling);
                        }
                        nextSibling = nextSibling.nextElementSibling;
                    }
                    
                    const summaryContainer = headerRow.querySelector('.phase-summary');
                    if(summaryContainer) {
                        const counts = {
                            total: elements.length,
                            required: elements.filter(el => el.querySelector('.submission-btn.required.active')).length,
                            notRequired: elements.filter(el => el.querySelector('.submission-btn.not-required.active')).length,
                            asRequested: elements.filter(el => el.querySelector('.submission-btn.as-requested.active')).length,
                            ifApplicable: elements.filter(el => el.querySelector('.submission-btn.if-applicable.active')).length
                        };
                        summaryContainer.querySelector('.total-count').textContent = counts.total;
                        summaryContainer.querySelector('.required-count').textContent = counts.required;
                        summaryContainer.querySelector('.not-required-count').textContent = counts.notRequired;
                        summaryContainer.querySelector('.as-requested-count').textContent = counts.asRequested;
                        summaryContainer.querySelector('.if-applicable-count').textContent = counts.ifApplicable;
                    }
                });
            }

            function updateOverallFormProgress() {
                const mandatoryFields = document.querySelectorAll('.mandatory-field');
                const totalMandatory = mandatoryFields.length;
                let completedMandatory = 0;

                mandatoryFields.forEach(field => {
                    let isComplete = false;
                    const fieldType = field.dataset.fieldType;

                    if (fieldType === 'user-list') {
                        if (field.querySelector('.user-list').children.length > 0) isComplete = true;
                    } else if (fieldType === 'button') {
                        // Placeholder logic
                    } else if (field.tagName === 'SELECT') {
                        if (field.value) isComplete = true;
                    } else {
                        if (field.value.trim() !== '') isComplete = true;
                    }

                    if(isComplete) completedMandatory++;
                });

                const percentage = totalMandatory > 0 ? (completedMandatory / totalMandatory) * 100 : 0;
                document.getElementById('overall-progress-bar').style.width = `${percentage}%`;
                document.getElementById('overall-progress-text').textContent = `${completedMandatory} of ${totalMandatory} mandatory fields complete`;
            }

            function attachAllEventListeners() {
                const reqTable = document.getElementById('requirements-table');
                reqTable.addEventListener('click', (e) => {
                    // If the click is on the submission buttons, handle that first and exit.
                    const submissionBtn = e.target.closest('.submission-btn');
                    if(submissionBtn) {
                        const group = submissionBtn.parentElement;
                        group.querySelectorAll('.submission-btn').forEach(btn => btn.classList.remove('active'));
                        submissionBtn.classList.add('active');
                        updatePhaseSummaries();
                        return; // Stop further execution
                    }

                    // If the click is anywhere else on an expandable row, toggle it.
                    const expandableRow = e.target.closest('.expandable-row');
                    if(expandableRow) {
                        toggleRow(expandableRow);
                    }
                });
                
                document.getElementById('expand-all-btn').addEventListener('click', () => toggleAllRows(true));
                document.getElementById('collapse-all-btn').addEventListener('click', () => toggleAllRows(false));

                document.querySelectorAll('.mandatory-field').forEach(field => {
                    field.addEventListener('change', updateOverallFormProgress);
                    field.addEventListener('input', updateOverallFormProgress);
                });

                document.querySelector('.lg\\:col-span-4').addEventListener('click', e => {
                    if (e.target.closest('.remove-user-btn')) {
                        e.target.closest('.p-2\\.5').remove();
                        updateOverallFormProgress();
                    }
                });
                
                const optionsToggle = document.getElementById('options-toggle');
                const optionsContent = document.getElementById('options-content');
                if (optionsToggle) {
                    optionsToggle.addEventListener('click', () => {
                        optionsToggle.classList.toggle('expanded');
                        optionsContent.classList.toggle('expanded');
                    });
                }


                setupDatePicker();
                setupUserSearch();
            }

            function toggleRow(row, forceState) {
                const detailsRow = row.nextElementSibling;
                const icon = row.querySelector('.fa-chevron-right');
                if (!detailsRow || !detailsRow.classList.contains('details-row')) return;
                
                const shouldBeOpen = forceState !== undefined ? forceState : detailsRow.classList.contains('hidden');
                
                detailsRow.classList.toggle('hidden', !shouldBeOpen);
                icon.classList.toggle('rotate-90', shouldBeOpen);
            }

            function toggleAllRows(open) {
                 document.querySelectorAll('#requirements-table .expandable-row').forEach(row => toggleRow(row, open));
            }

            function setupDatePicker() {
                const datepickerContainer = document.getElementById('datepicker-container');
                let activeDateTrigger = null; let currentDate = new Date(); currentDate.setHours(0,0,0,0);
                function getWeekNumber(d) {
                    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                }
                function renderDatepicker(year, month) {
                    const firstDay = new Date(year, month, 1);
                    let html = `<div class="datepicker-header"><button type="button" class="prev-month p-2 rounded-full hover:bg-gray-100"><i class="fas fa-chevron-left"></i></button><div class="font-semibold">${firstDay.toLocaleString('default', { month: 'long' })} ${year}</div><button type="button" class="next-month p-2 rounded-full hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button></div><div class="datepicker-grid"><div class="datepicker-day-name">Wk</div>`;
                    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => { html += `<div class="datepicker-day-name">${day}</div>`; });
                    let dayCounter = 1; let gridCells = [];
                    for (let i = 0; i < 42; i++) {
                        if (i < firstDay.getDay() || dayCounter > new Date(year, month + 1, 0).getDate()) { gridCells.push('<div></div>'); } 
                        else { gridCells.push(`<div class="datepicker-day" data-date="${new Date(year, month, dayCounter).toISOString()}">${dayCounter++}</div>`);}
                    }
                    for(let i=0; i<gridCells.length; i+=7) {
                        html += `<div class="datepicker-week">${getWeekNumber(new Date(year, month, (i - firstDay.getDay()) + 2))}</div>`;
                        html += gridCells.slice(i, i + 7).join('');
                    }
                    datepickerContainer.innerHTML = html + '</div>';
                }
                document.querySelectorAll('.datepicker-trigger').forEach(trigger => {
                    trigger.addEventListener('click', e => {
                        e.stopPropagation(); activeDateTrigger = trigger;
                        const rect = trigger.getBoundingClientRect();
                        datepickerContainer.style.top = `${rect.bottom + window.scrollY + 5}px`;
                        datepickerContainer.style.left = `${rect.left + window.scrollX}px`;
                        currentDate = new Date(); renderDatepicker(currentDate.getFullYear(), currentDate.getMonth());
                        datepickerContainer.classList.add('active');
                    });
                });
                datepickerContainer.addEventListener('click', e => {
                    e.stopPropagation();
                    const day = e.target.closest('.datepicker-day');
                    if (day && !day.classList.contains('disabled')) {
                         const selectedDate = new Date(day.dataset.date);
                         const hiddenInput = activeDateTrigger.querySelector('.date-input');
                         hiddenInput.value = selectedDate.toISOString(); hiddenInput.dispatchEvent(new Event('change'));
                         activeDateTrigger.querySelector('.date-display').textContent = selectedDate.toLocaleDateString('en-CA');
                         activeDateTrigger.querySelector('.week-tag').textContent = 'Week ' + getWeekNumber(selectedDate);
                         activeDateTrigger.querySelector('.week-tag').classList.remove('hidden');
                         datepickerContainer.classList.remove('active');
                    } else if (e.target.closest('.prev-month')) {
                        currentDate.setMonth(currentDate.getMonth() - 1); renderDatepicker(currentDate.getFullYear(), currentDate.getMonth());
                    } else if (e.target.closest('.next-month')) {
                        currentDate.setMonth(currentDate.getMonth() + 1); renderDatepicker(currentDate.getFullYear(), currentDate.getMonth());
                    }
                });
                document.addEventListener('click', () => datepickerContainer.classList.remove('active'));
            }

            function setupUserSearch() {
                document.querySelectorAll('.user-search-input').forEach(input => {
                    const container = input.closest('.user-search-container');
                    const dropdown = container.querySelector('.search-results-dropdown');
                    const userList = container.parentElement.querySelector('.user-list');

                    input.addEventListener('input', () => {
                        const searchTerm = input.value.toLowerCase().trim();

                        if (searchTerm.length < 3) {
                            dropdown.innerHTML = '';
                            dropdown.classList.add('hidden');
                            return;
                        }

                        const existingEmails = Array.from(userList.querySelectorAll('.user-email')).map(el => el.textContent);
                        const filteredUsers = allUsers.filter(user =>
                            !existingEmails.includes(user.email) &&
                            (user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm))
                        );

                        if (filteredUsers.length > 0) {
                            dropdown.innerHTML = filteredUsers.map(user => `
                                <div class="p-3 hover:bg-gray-100 cursor-pointer user-search-item" data-name="${user.name}" data-email="${user.email}">
                                    <p class="font-semibold text-sm">${user.name}</p>
                                    <p class="text-xs text-gray-500">${user.email}</p>
                                </div>
                            `).join('');
                        } else {
                            dropdown.innerHTML = `<div class="p-3 text-sm text-gray-500">No results found</div>`;
                        }
                        dropdown.classList.remove('hidden');
                    });

                    dropdown.addEventListener('click', (e) => {
                         const selectedItem = e.target.closest('.user-search-item');
                         if (!selectedItem) return;

                         const name = selectedItem.dataset.name;
                         const email = selectedItem.dataset.email;
                         addUserToList(name, email, userList);
                         
                         input.value = '';
                         dropdown.classList.add('hidden');
                         updateOverallFormProgress();
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.user-search-container')) {
                        document.querySelectorAll('.search-results-dropdown').forEach(d => d.classList.add('hidden'));
                    }
                });
            }

            function addUserToList(name, email, listElement) {
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
                const newUserHTML = `
                    <div class="p-2.5 bg-gray-50 rounded-lg flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <img src="https://placehold.co/32x32/dbeafe/1e40af?text=${initials}" class="rounded-full">
                            <div>
                                <p class="font-semibold text-sm">${name}</p>
                                <p class="text-xs text-gray-500 user-email">${email}</p>
                            </div>
                        </div>
                        <button class="text-gray-400 hover:text-red-500 remove-user-btn"><i class="fas fa-times"></i></button>
                    </div>`;
                listElement.insertAdjacentHTML('beforeend', newUserHTML);
            }

            initializeApp();
        });
    </script>
</body>
</html>
