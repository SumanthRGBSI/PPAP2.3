import React, { useState, useCallback, useRef, useEffect, useMemo } from 'react';
import { useDropzone } from 'react-dropzone';
import { 
    FileText, X, Eye, Lock, Unlock, UploadCloud, CheckCircle, 
    ChevronDown, Info, Upload, Search, MoreVertical, Loader2 
} from 'lucide-react';

// Mock data based on the user-provided list with updated requirement statuses
const initialElements = [
    { id: 1, name: 'Design Records (Preliminary)', phase: 1, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 2, name: 'Authorized Engineering Changes (if available)', phase: 1, status: 'Not Submitted', files: [], requirement: 'If applicable' },
    { id: 3, name: 'Customer Engineering Approval (if required)', phase: 1, status: 'Not Submitted', files: [], requirement: 'As requested' },
    { id: 4, name: 'DFMEA (initial draft)', phase: 1, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 5, name: 'Process Flow Diagram (conceptual)', phase: 1, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 6, name: 'Updated DFMEA', phase: 2, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 7, name: 'Preliminary PFMEA (draft)', phase: 2, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 8, name: 'Draft Control Plan (prototype)', phase: 2, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 9, name: 'Material & Performance Test Plan (if defined)', phase: 2, status: 'Not Submitted', files: [], requirement: 'Optional' },
    { id: 10, name: 'Preliminary MSA Plan (gage strategy)', phase: 2, status: 'Not Submitted', files: [], requirement: 'Optional' },
    { id: 11, name: 'Finalized PFMEA', phase: 3, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 12, name: 'Control Plan (Pre-launch version)', phase: 3, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 13, name: 'Gage R&R / MSA Studies (initial)', phase: 3, status: 'Not Submitted', files: [], requirement: 'As requested' },
    { id: 14, name: 'Dimensional Results (preliminary layout)', phase: 3, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 15, name: 'Material Test Reports (trial runs)', phase: 3, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 16, name: 'SPC Plan defined', phase: 3, status: 'Not Submitted', files: [], requirement: 'Optional' },
    { id: 17, name: 'Final PFMEA', phase: 4, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 18, name: 'Final Control Plan (Production version)', phase: 4, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 19, name: 'MSA Studies (complete)', phase: 4, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 20, name: 'Dimensional Results (full layout)', phase: 4, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 21, name: 'Records of Material / Performance Tests (certified results)', phase: 4, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 22, name: 'Initial Process Studies (Cp, Cpk)', phase: 4, status: 'Not Submitted', files: [], requirement: 'As requested' },
    { id: 23, name: 'Appearance Approval Report (if applicable)', phase: 4, status: 'Not Submitted', files: [], requirement: 'If applicable' },
    { id: 24, name: 'Checking Aids documentation', phase: 4, status: 'Not Submitted', files: [], requirement: 'Optional' },
    { id: 25, name: 'Master Sample', phase: 5, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 26, name: 'Customer-Specific Requirements (fulfilled)', phase: 5, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 27, name: 'Part Submission Warrant (PSW) signed-off', phase: 5, status: 'Not Submitted', files: [], requirement: 'Required' },
    { id: 28, name: 'Ongoing SPC and capability studies', phase: 5, status: 'Not Submitted', files: [], requirement: 'As requested' },
    { id: 29, name: 'Lessons Learned / Feedback loop', phase: 5, status: 'Not Submitted', files: [], requirement: 'If applicable' },
];

const phases = [
    { id: 1, name: 'Phase 1 – Planning & Definition' },
    { id: 2, name: 'Phase 2 – Design & Development' },
    { id: 3, name: 'Phase 3 – Process Design & Development' },
    { id: 4, name: 'Phase 4 – Product & Process Validation' },
    { id: 5, name: 'Phase 5 – Feedback, Assessment & Corrective Action' },
];

const formatBytes = (bytes, decimals = 2) => {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
};

const FileActionMenu = ({ file, onView, onToggleConfidential, onDelete }) => {
    const [isOpen, setIsOpen] = useState(false);
    const menuRef = useRef(null);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (menuRef.current && !menuRef.current.contains(event.target)) setIsOpen(false);
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    return (
        <div className="relative" ref={menuRef}>
            <button onClick={() => setIsOpen(!isOpen)} className="p-2 text-slate-500 hover:text-indigo-600 rounded-full transition-colors">
                <MoreVertical className="w-4 h-4" />
            </button>
            {isOpen && (
                <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-slate-200">
                    <ul className="py-1">
                        <li><a href="#" onClick={(e) => { e.preventDefault(); onView(); setIsOpen(false); }} className="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><Eye className="w-4 h-4" /> View</a></li>
                        <li><a href="#" onClick={(e) => { e.preventDefault(); onToggleConfidential(); setIsOpen(false); }} className="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">{file.confidential ? <Unlock className="w-4 h-4" /> : <Lock className="w-4 h-4" />} {file.confidential ? 'Make Public' : 'Make Confidential'}</a></li>
                        <li><a href="#" onClick={(e) => { e.preventDefault(); onDelete(); setIsOpen(false); }} className="flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50"><X className="w-4 h-4" /> Delete</a></li>
                    </ul>
                </div>
            )}
        </div>
    );
};

const DocumentDetailView = ({ element, onFileChange }) => {
    const onDrop = useCallback(acceptedFiles => {
        const newFiles = acceptedFiles.map(file => Object.assign(file, {
            preview: URL.createObjectURL(file),
            confidential: false,
            id: Math.random().toString(36).substring(7),
        }));
        onFileChange(element.id, [...element.files, ...newFiles]);
    }, [element, onFileChange]);

    const { getRootProps, getInputProps, isDragActive } = useDropzone({ onDrop, multiple: true });

    return (
        <div className="bg-slate-100 p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-3 max-h-64 overflow-y-auto pr-2">
                {element.files.length > 0 ? (
                    element.files.map(file => (
                        <div key={file.id} className="flex items-center justify-between bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm">
                            <div className="flex items-center space-x-3 overflow-hidden">
                                <FileText className="w-6 h-6 text-indigo-500 flex-shrink-0" />
                                <div className="overflow-hidden">
                                    <p className="truncate text-sm font-medium text-slate-800" title={file.name}>{file.name}</p>
                                    <p className="text-xs text-slate-500">
                                        {formatBytes(file.size)}
                                        {file.confidential && <span className="ml-2 font-semibold text-amber-600">Confidential</span>}
                                    </p>
                                </div>
                            </div>
                            <FileActionMenu 
                                file={file}
                                onView={() => window.open(file.preview, '_blank')}
                                onToggleConfidential={() => onFileChange(element.id, element.files.map(f => f.id === file.id ? { ...f, confidential: !f.confidential } : f))}
                                onDelete={() => onFileChange(element.id, element.files.filter(f => f.id !== file.id))}
                            />
                        </div>
                    ))
                ) : (
                    <div className="text-center text-slate-500 py-10">
                        <UploadCloud className="w-12 h-12 mx-auto text-slate-400 mb-2"/>
                        <p className="font-semibold">No documents uploaded.</p>
                        <p className="text-sm">Drop files in the zone to the right to add them.</p>
                    </div>
                )}
            </div>
            <div {...getRootProps()} className={`border-2 border-dashed rounded-lg p-4 flex items-center justify-center text-center cursor-pointer transition-colors duration-200 h-full ${isDragActive ? 'border-indigo-600 bg-indigo-100' : 'border-slate-300 hover:border-indigo-500 bg-white'}`}>
                <input {...getInputProps()} />
                <div className="flex flex-col items-center text-slate-500">
                    <UploadCloud className="w-12 h-12 mb-3" />
                    <p className="font-semibold">{isDragActive ? "Drop files here..." : "Drag & drop files"}</p>
                    <p className="text-sm">or click to select</p>
                </div>
            </div>
        </div>
    );
};

const ElementRow = ({ element, isSelected, isExpanded, onSelect, onFileChange, onToggleExpand }) => {
    const onDrop = useCallback(acceptedFiles => {
        const newFiles = acceptedFiles.map(f => Object.assign(f, { preview: URL.createObjectURL(f), confidential: false, id: Math.random().toString(36).substring(7) }));
        onFileChange(element.id, [...element.files, ...newFiles]);
    }, [element, onFileChange]);

    const { getRootProps, getInputProps, isDragActive } = useDropzone({ onDrop, noKeyboard: true });

    const getStatusChip = (status) => ({
        'Submitted': <span className="px-2.5 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full flex items-center gap-1.5"><CheckCircle className="w-4 h-4" />{status}</span>,
        'Draft': <span className="px-2.5 py-1 text-xs font-semibold text-blue-800 bg-blue-200 rounded-full flex items-center gap-1.5"><Info className="w-4 h-4" />{status}</span>,
        'Not Submitted': <span className="px-2.5 py-1 text-xs font-semibold text-slate-700 bg-slate-200 rounded-full">{status}</span>
    }[status]);

    const getRequirementIndicator = (requirement) => {
        switch (requirement) {
            case 'Required':
                return <span className="flex items-center justify-center w-6 h-6 bg-green-100 text-green-700 rounded-full font-bold text-sm">✓</span>;
            case 'If applicable':
                return <span className="flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-700 rounded-full font-bold text-xs">IA</span>;
            case 'As requested':
                return <span className="flex items-center justify-center w-6 h-6 bg-purple-100 text-purple-700 rounded-full font-bold text-xs">AR</span>;
            default:
                return <span className="text-slate-500 text-sm">Optional</span>;
        }
    };

    const baseBg = useMemo(() => {
        if (isSelected) return 'bg-blue-100';
        if (element.status === 'Submitted') return 'bg-green-100';
        if (element.status === 'Draft') return 'bg-green-100';
        return 'even:bg-slate-50 bg-white';
    }, [isSelected, element.status]);
    
    const rowClasses = `transition-colors duration-150 cursor-pointer ${baseBg} ${isSelected ? 'border-l-4 border-blue-500' : ''} hover:bg-blue-100`;

    return (
        <tr onClick={() => onSelect(element.id)} className={rowClasses}>
            <td className="p-4 border-b border-slate-200">
                <input type="checkbox" className="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 pointer-events-none" checked={isSelected} readOnly />
            </td>
            <td className="px-6 py-3 text-sm font-medium text-slate-800 border-b border-slate-200" title={element.name}>
                 <p className="truncate w-80">{element.name}</p>
            </td>
            <td className="px-6 py-3 whitespace-nowrap text-sm text-slate-600 border-b border-slate-200">
                {getRequirementIndicator(element.requirement)}
            </td>
            <td className="px-6 py-3 whitespace-nowrap text-sm border-b border-slate-200">{getStatusChip(element.status)}</td>
            <td className="px-6 py-3 border-b border-slate-200" onClick={e => e.stopPropagation()}>
                <div {...getRootProps()} className={`relative p-2 border-2 border-dashed rounded-md text-center transition-all duration-200 min-h-[60px] flex flex-col justify-center items-center cursor-pointer ${isDragActive ? 'border-indigo-600 bg-indigo-100 scale-105 shadow-lg' : 'border-slate-300 bg-slate-50 hover:border-indigo-400 hover:bg-indigo-50'}`}>
                    <input {...getInputProps()} />
                     {isDragActive ? (
                        <div className="text-indigo-700 font-semibold"><Upload className="w-5 h-5 mx-auto mb-1 animate-bounce" /><span className="text-sm">Drop Here</span></div>
                    ) : (
                        <div className="text-slate-600">
                            {element.files.length > 0 ? (
                                <div className="font-semibold text-sm">{element.files.length} {element.files.length === 1 ? 'File' : 'Files'}</div>
                            ) : (
                                <div className="flex flex-col items-center text-slate-500"><UploadCloud className="w-5 h-5 mb-1" /><span className="text-xs font-semibold">Drop/Click to Upload</span></div>
                            )}
                        </div>
                    )}
                    <button onClick={() => onToggleExpand(element.id)} className="absolute top-1 right-1 text-slate-500 hover:text-slate-800 p-0.5 rounded-full hover:bg-slate-200 transition-colors" title="View files">
                        <ChevronDown className={`w-5 h-5 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} />
                    </button>
                </div>
            </td>
        </tr>
    );
};

const PhaseAccordion = ({ phase, elements, ...props }) => {
    const [isOpen, setIsOpen] = useState(true);
    const phaseElementIds = useMemo(() => elements.map(el => el.id), [elements]);
    const areAllInPhaseSelected = useMemo(() => phaseElementIds.length > 0 && phaseElementIds.every(id => props.selectedElements.includes(id)), [phaseElementIds, props.selectedElements]);

    return (
        <tbody className="bg-white">
            <tr className="bg-slate-200 border-y-2 border-slate-300">
                <td colSpan="5" className="px-4 py-2 text-left font-bold text-slate-800">
                    <div className="flex items-center gap-4">
                        <input type="checkbox" onChange={(e) => props.onSelectAllInPhase(phase.id, e.target.checked)} checked={areAllInPhaseSelected} className="h-5 w-5 text-indigo-600 border-gray-400 rounded focus:ring-indigo-500" title={`Select all in ${phase.name}`} />
                        <button onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-2 w-full text-indigo-800 hover:text-indigo-600">
                            {phase.name}
                            <ChevronDown className={`w-5 h-5 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} />
                        </button>
                    </div>
                </td>
            </tr>
            {isOpen && elements.map(element => (
                <React.Fragment key={element.id}>
                    <ElementRow {...props} element={element} isSelected={props.selectedElements.includes(element.id)} isExpanded={props.expandedElementId === element.id} />
                    {props.expandedElementId === element.id && (
                        <tr className="bg-slate-50"><td colSpan="5" className="p-0 border-b border-slate-300"><DocumentDetailView element={element} onFileChange={props.onFileChange} /></td></tr>
                    )}
                </React.Fragment>
            ))}
        </tbody>
    );
};

export default function App() {
    const [elements, setElements] = useState(initialElements);
    const [selectedElements, setSelectedElements] = useState([]);
    const [expandedElementId, setExpandedElementId] = useState(null);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [toast, setToast] = useState({ show: false, message: '', type: 'success' });

    const showToast = (message, type = 'success') => {
        setToast({ show: true, message, type });
        setTimeout(() => setToast({ show: false, message: '', type: 'success' }), 3000);
    };

    const handleFileChange = (elementId, files) => setElements(prev => prev.map(el => el.id === elementId ? { ...el, files, status: el.status === 'Submitted' ? 'Submitted' : files.length > 0 ? 'Draft' : 'Not Submitted' } : el));
    const handleSelect = (elementId) => setSelectedElements(prev => prev.includes(elementId) ? prev.filter(id => id !== elementId) : [...prev, elementId]);

    const handleSelectAllInPhase = (phaseId, isSelected) => {
        const phaseElementIds = elements.filter(el => el.phase === phaseId).map(el => el.id);
        setSelectedElements(prev => isSelected ? [...new Set([...prev, ...phaseElementIds])] : prev.filter(id => !phaseElementIds.includes(id)));
    };

    const confirmSubmission = () => {
        if (elements.filter(el => selectedElements.includes(el.id)).some(el => el.files.length === 0)) {
            showToast('Cannot submit. Some selected elements have no files.', 'error');
            return;
        }
        setShowConfirmModal(true);
    };

    const handleSubmit = () => {
        setShowConfirmModal(false);
        setIsSubmitting(true);
        setTimeout(() => { // Simulate API call
            setElements(prev => prev.map(el => selectedElements.includes(el.id) ? { ...el, status: 'Submitted' } : el));
            setSelectedElements([]);
            setExpandedElementId(null);
            setIsSubmitting(false);
            showToast(`Successfully submitted ${selectedElements.length} element(s).`);
        }, 1500);
    };
    
    const handleToggleExpand = (elementId) => setExpandedElementId(prev => prev === elementId ? null : elementId);
    
    const filesAttachedCount = useMemo(() => elements.filter(el => el.files.length > 0).length, [elements]);

    return (
        <div className="bg-slate-100 h-screen font-sans flex flex-col">
            <header className="flex-shrink-0 z-30 bg-white/90 backdrop-blur-lg border-b border-slate-200">
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
                    <div className="flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-900">Bulk Document Submission</h1>
                            <p className="text-slate-600 text-sm mt-1">
                                {filesAttachedCount} of {elements.length} elements have files attached.
                                <span className="inline-block w-48 h-2 bg-slate-200 rounded-full ml-3 align-middle overflow-hidden">
                                    <span className="block h-2 bg-indigo-500 rounded-full transition-all duration-300" style={{ width: `${(filesAttachedCount / elements.length) * 100}%` }}></span>
                                </span>
                            </p>
                        </div>
                         <button onClick={confirmSubmission} disabled={selectedElements.length === 0 || isSubmitting} className="px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-slate-400 disabled:cursor-not-allowed transition-all duration-200 flex items-center gap-2">
                             {isSubmitting ? <><Loader2 className="w-5 h-5 animate-spin" /> Submitting...</> : <>Submit Selected ({selectedElements.length})</>}
                         </button>
                    </div>
                </div>
            </header>

            <main className="flex-grow overflow-hidden container mx-auto p-4 sm:p-6 lg:p-8">
                <div className="bg-white shadow-xl rounded-xl border border-slate-200 h-full flex flex-col">
                    <div className="overflow-auto">
                         <table className="min-w-full border-separate border-spacing-0">
                            <thead className="bg-slate-50 sticky top-0 z-10">
                                <tr>
                                    <th className="p-4 text-left border-b-2 border-slate-200 w-16"></th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider border-b-2 border-slate-200">Element</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider border-b-2 border-slate-200">Required</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider border-b-2 border-slate-200">Status</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider border-b-2 border-slate-200 w-56">Submissions</th>
                                </tr>
                            </thead>
                            {phases.map(phase => {
                                const phaseElements = elements.filter(el => el.phase === phase.id);
                                if (phaseElements.length === 0) return null;
                                return <PhaseAccordion key={phase.id} phase={phase} elements={phaseElements} selectedElements={selectedElements} expandedElementId={expandedElementId} onFileChange={handleFileChange} onSelect={handleSelect} onToggleExpand={handleToggleExpand} onSelectAllInPhase={handleSelectAllInPhase} />
                            })}
                        </table>
                    </div>
                </div>
            </main>

            {toast.show && (
                <div className={`fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white ${toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'} transition-all duration-300`}>
                    {toast.message}
                </div>
            )}
            
            {showConfirmModal && (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                        <h3 className="text-lg font-bold text-slate-800">Confirm Submission</h3>
                        <p className="text-slate-600 mt-2">You are about to submit <span className="font-bold">{selectedElements.length}</span> element(s). This may overwrite previous submissions. Are you sure?</p>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={() => setShowConfirmModal(false)} className="px-4 py-2 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300">Cancel</button>
                            <button onClick={handleSubmit} className="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Confirm & Submit</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

