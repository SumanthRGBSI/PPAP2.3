<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bulk Document Submission</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' },
            success: { 600: '#16a34a', 700: '#15803d' }
          }
        }
      }
    }
  </script>
  <style>
    body { background-color: #f8fafc; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 4px 6px -1px rgb(0 0 0 / .05), 0 2px 4px -2px rgb(0 0 0 / .05); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    .badge { padding: 2px 8px; border-radius: 9999px; font-size: .75rem; font-weight: 600; display: inline-flex; align-items:center; gap:6px; }
    .badge-draft { background:#dbeafe; color:#1e40af; }
    .badge-submitted { background:#dcfce7; color:#166534; }
    .badge-none { background:#e2e8f0; color:#334155; }
    .dropzone { border:2px dashed #cbd5e1; border-radius:.5rem; padding:.5rem; background:#f8fafc; text-align:center; transition: all .2s ease; }
    .dropzone.dragover { border-color:#4f46e5; background:#eef2ff; transform: scale(1.02); }
    .menu { position: relative; display:inline-block; }
    .menu-list { display:none; position:absolute; right:0; top:calc(100% + 4px); background:#fff; border:1px solid #e5e7eb; border-radius:.5rem; box-shadow:0 4px 6px -1px rgb(0 0 0 / .1), 0 2px 4px -2px rgb(0 0 0 / .1); min-width: 160px; z-index: 20; }
    .menu.open .menu-list { display:block; }
    .menu-item { padding:.5rem .75rem; display:flex; align-items:center; gap:.5rem; font-size:.875rem; color:#374151; }
    .menu-item:hover { background:#f8fafc; }
    .phase-header { background:#e5e7eb; }
  </style>
</head>
<body class="font-sans text-slate-800">
  <header class="bg-white/90 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-50">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-3">
        <a href="./index.html" class="flex items-center gap-2" title="Back to Hub">
          <span class="inline-flex h-8 w-8 rounded-lg bg-primary-600 text-white items-center justify-center font-extrabold">P</span>
          <span class="text-sm font-semibold text-gray-900">PPAP Hub</span>
        </a>
        <nav class="flex items-center gap-1">
          <a href="./PPAP Creation Page.html" class="px-3 py-2 text-sm font-medium rounded-md text-slate-700 hover:text-primary-700 hover:bg-primary-50">Creation</a>
          <a href="./PPAP View Page.html" class="px-3 py-2 text-sm font-medium rounded-md text-slate-700 hover:text-primary-700 hover:bg-primary-50">View</a>
          <a href="./Bulk Submit.html" class="px-3 py-2 text-sm font-medium rounded-md bg-primary-600 text-white hover:bg-primary-700">Bulk Submit</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="card p-5 sm:p-6">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h1 class="text-2xl font-bold text-slate-900">Bulk Document Submission</h1>
          <p id="progressText" class="text-slate-600 text-sm mt-1">0 of 29 elements have files attached.</p>
          <div class="w-56 h-2 bg-slate-200 rounded-full mt-2 overflow-hidden">
            <div id="progressBar" class="h-2 bg-primary-600 rounded-full" style="width:0%"></div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="expandAll" class="px-3 py-1.5 text-xs bg-white border border-slate-300 rounded-md hover:bg-slate-50">Expand All</button>
          <button id="collapseAll" class="px-3 py-1.5 text-xs bg-white border border-slate-300 rounded-md hover:bg-slate-50">Collapse All</button>
          <button id="submitBtn" class="px-5 py-2.5 bg-primary-600 text-white font-semibold rounded-lg shadow-sm hover:bg-primary-700 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-2" disabled>
            Submit Selected (0)
          </button>
        </div>
      </div>

      <div class="mt-6 overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-50 text-slate-600 uppercase text-xs sticky top-0 z-10">
            <tr>
              <th class="p-3 w-12"></th>
              <th class="p-3 text-left">Element</th>
              <th class="p-3 text-left">Required</th>
              <th class="p-3 text-left">Status</th>
              <th class="p-3 text-left w-72">Submissions</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="align-top"></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="card p-4 flex items-center justify-between">
      <a href="./index.html" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
        Back to Hub
      </a>
      <div class="text-sm text-slate-500">Attach files (drag & drop), select rows, and submit.</div>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 hidden px-4 py-2 rounded-lg text-white shadow-lg"></div>
  <!-- Confirm Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
      <h3 class="text-lg font-bold text-slate-800">Confirm Submission</h3>
      <p class="text-slate-600 mt-2">You are about to submit <span id="confirmCount" class="font-bold">0</span> element(s). This may overwrite previous submissions. Are you sure?</p>
      <div class="flex justify-end gap-3 mt-6">
        <button id="cancelConfirm" class="px-4 py-2 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300">Cancel</button>
        <button id="okConfirm" class="px-4 py-2 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700">Confirm & Submit</button>
      </div>
    </div>
  </div>

  <script>
    // Data
    const elements = [
      { id: 1, name: 'Design Records (Preliminary)', phase: 1, requirement: 'Required' },
      { id: 2, name: 'Authorized Engineering Changes (if available)', phase: 1, requirement: 'If applicable' },
      { id: 3, name: 'Customer Engineering Approval (if required)', phase: 1, requirement: 'As requested' },
      { id: 4, name: 'DFMEA (initial draft)', phase: 1, requirement: 'Required' },
      { id: 5, name: 'Process Flow Diagram (conceptual)', phase: 1, requirement: 'Required' },
      { id: 6, name: 'Updated DFMEA', phase: 2, requirement: 'Required' },
      { id: 7, name: 'Preliminary PFMEA (draft)', phase: 2, requirement: 'Required' },
      { id: 8, name: 'Draft Control Plan (prototype)', phase: 2, requirement: 'Required' },
      { id: 9, name: 'Material & Performance Test Plan (if defined)', phase: 2, requirement: 'Optional' },
      { id: 10, name: 'Preliminary MSA Plan (gage strategy)', phase: 2, requirement: 'Optional' },
      { id: 11, name: 'Finalized PFMEA', phase: 3, requirement: 'Required' },
      { id: 12, name: 'Control Plan (Pre-launch version)', phase: 3, requirement: 'Required' },
      { id: 13, name: 'Gage R\u0026R / MSA Studies (initial)', phase: 3, requirement: 'As requested' },
      { id: 14, name: 'Dimensional Results (preliminary layout)', phase: 3, requirement: 'Required' },
      { id: 15, name: 'Material Test Reports (trial runs)', phase: 3, requirement: 'Required' },
      { id: 16, name: 'SPC Plan defined', phase: 3, requirement: 'Optional' },
      { id: 17, name: 'Final PFMEA', phase: 4, requirement: 'Required' },
      { id: 18, name: 'Final Control Plan (Production version)', phase: 4, requirement: 'Required' },
      { id: 19, name: 'MSA Studies (complete)', phase: 4, requirement: 'Required' },
      { id: 20, name: 'Dimensional Results (full layout)', phase: 4, requirement: 'Required' },
      { id: 21, name: 'Records of Material / Performance Tests (certified results)', phase: 4, requirement: 'Required' },
      { id: 22, name: 'Initial Process Studies (Cp, Cpk)', phase: 4, requirement: 'As requested' },
      { id: 23, name: 'Appearance Approval Report (if applicable)', phase: 4, requirement: 'If applicable' },
      { id: 24, name: 'Checking Aids documentation', phase: 4, requirement: 'Optional' },
      { id: 25, name: 'Master Sample', phase: 5, requirement: 'Required' },
      { id: 26, name: 'Customer-Specific Requirements (fulfilled)', phase: 5, requirement: 'Required' },
      { id: 27, name: 'Part Submission Warrant (PSW) signed-off', phase: 5, requirement: 'Required' },
      { id: 28, name: 'Ongoing SPC and capability studies', phase: 5, requirement: 'As requested' },
      { id: 29, name: 'Lessons Learned / Feedback loop', phase: 5, requirement: 'If applicable' },
    ].map(e => ({ ...e, files: [], status: 'Not Submitted', selected: false }));

    const phases = [
      { id: 1, name: 'Phase 1 – Planning & Definition' },
      { id: 2, name: 'Phase 2 – Design & Development' },
      { id: 3, name: 'Phase 3 – Process Design & Development' },
      { id: 4, name: 'Phase 4 – Product & Process Validation' },
      { id: 5, name: 'Phase 5 – Feedback, Assessment & Corrective Action' },
    ];

    const tableBody = document.getElementById('tableBody');
    const submitBtn = document.getElementById('submitBtn');
    const toast = document.getElementById('toast');
    const confirmModal = document.getElementById('confirmModal');
    const confirmCount = document.getElementById('confirmCount');
    const cancelConfirm = document.getElementById('cancelConfirm');
    const okConfirm = document.getElementById('okConfirm');
    const expandAllBtn = document.getElementById('expandAll');
    const collapseAllBtn = document.getElementById('collapseAll');
    const expandedDetails = new Set();

    const phaseCollapsed = new Map(phases.map(p => [p.id, false]));

    function requirementBadge(req){
      if (req === 'Required') return '<span class="badge" style="background:#dcfce7;color:#166534" title="Required">\
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>\
      </span>';
      if (req === 'If applicable') return '<span class="badge" style="background:#dbeafe;color:#1e40af" title="If Applicable">IA</span>';
      if (req === 'As requested') return '<span class="badge" style="background:#f3e8ff;color:#6b21a8" title="As Requested">AR</span>';
      return '<span class="badge" style="background:#e2e8f0;color:#334155" title="Optional">\
        <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="3"/></svg>\
      </span>';
    }

    function statusBadge(status){
      if (status === 'Draft') return '<span class="badge badge-draft">Draft</span>';
      if (status === 'Submitted') return '<span class="badge badge-submitted">Submitted</span>';
      return '<span class="badge badge-none">Not Submitted</span>';
    }

    function updateProgress(){
      const withFiles = elements.filter(e => e.files.length > 0).length;
      const pct = (withFiles / elements.length) * 100;
      document.getElementById('progressText').textContent = `${withFiles} of ${elements.length} elements have files attached.`;
      document.getElementById('progressBar').style.width = `${pct}%`;
    }

    function updateSubmitState(){
      const selectedCount = elements.filter(e => e.selected).length;
      submitBtn.disabled = selectedCount === 0;
      submitBtn.textContent = `Submit Selected (${selectedCount})`;
      confirmCount.textContent = selectedCount;
    }

    function showToast(message, ok=true){
      toast.textContent = message;
      toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-lg text-white shadow-lg ${ok ? 'bg-green-600' : 'bg-red-600'}`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2500);
    }

    function attachDropzoneEvents(container, el){
      container.addEventListener('dragover', (ev) => { ev.preventDefault(); container.classList.add('dragover'); });
      container.addEventListener('dragenter', (ev) => { ev.preventDefault(); container.classList.add('dragover'); });
      container.addEventListener('dragleave', () => container.classList.remove('dragover'));
      container.addEventListener('drop', (ev) => {
        ev.preventDefault(); container.classList.remove('dragover');
        const files = Array.from(ev.dataTransfer.files);
        if (!files.length) return;
        const toAdd = files.map(f => ({ file: f, name: f.name, size: f.size, _id: `${Date.now()}-${Math.random().toString(36).slice(2)}` , confidential:false, url: URL.createObjectURL(f) }));
        el.files.push(...toAdd);
        el.status = 'Draft';
        render();
        
      });
    }

    function render(){
      tableBody.innerHTML = '';
      phases.forEach(phase => {
        const phaseEls = elements.filter(e => e.phase === phase.id);
        if (phaseEls.length === 0) return;
        const header = document.createElement('tr');
        const allSelected = phaseEls.every(e => e.selected);
        const anySelected = phaseEls.some(e => e.selected);
        const collapsed = phaseCollapsed.get(phase.id);
        header.innerHTML = `
          <td colspan="5" class="bg-slate-200 border-y-2 border-slate-300 px-4 py-2 font-bold text-slate-800">
            <div class="flex items-center gap-4">
              <input type="checkbox" class="h-5 w-5 text-primary-600 border-gray-400 rounded" data-action="phase-select" data-phase="${phase.id}" ${allSelected ? 'checked' : ''} ${(!allSelected && anySelected) ? 'indeterminate' : ''}>
              <button class="text-left flex items-center gap-2" data-action="phase-toggle" data-phase="${phase.id}">
                ${phase.name}
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform ${collapsed ? '' : 'rotate-180'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
            </div>
          </td>`;
        tableBody.appendChild(header);

        if (collapsed) return;

        phaseEls.forEach(el => {
          const tr = document.createElement('tr');
          tr.className = 'even:bg-slate-50';
          const filesCount = el.files.length;
          const isExpanded = expandedDetails.has(el.id);
          tr.innerHTML = `
            <td class="p-3 align-top"><input type="checkbox" class="h-5 w-5 text-primary-600 border-gray-300 rounded row-select" data-id="${el.id}" ${el.selected ? 'checked' : ''}></td>
            <td class="p-3 align-top text-slate-800 font-medium" title="${el.name}"><p class="truncate w-80">${el.name}</p></td>
            <td class="p-3 align-top">${requirementBadge(el.requirement)}</td>
            <td class="p-3 align-top">${statusBadge(el.status)}</td>
            <td class="p-3 align-top">
              <div class="dropzone" data-dropzone-id="${el.id}">
                <div class="text-slate-600">
                  ${filesCount > 0 ? `<div class='font-semibold text-sm mb-1'>${filesCount} ${filesCount === 1 ? 'File' : 'Files'}</div>` : `<div class='flex flex-col items-center text-slate-500 text-xs'><svg xmlns='http://www.w3.org/2000/svg' class='w-5 h-5 mb-1' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 16V8m0 0l-3 3m3-3l3 3M17 8v8m0 0l-3-3m3 3l3-3'/></svg>Drop/Click to Upload</div>`}
                </div>
                <div class="mt-2 flex items-center gap-2 justify-center">
                  <input id="file-${el.id}" type="file" class="hidden" multiple />
                  <button class="px-3 py-1.5 bg-white border border-slate-300 rounded-md hover:bg-slate-50 text-slate-700 text-sm" data-action="add-files" data-id="${el.id}">Add Files</button>
                  <button class="text-xs text-primary-700 hover:underline" data-action="toggle-files" data-id="${el.id}">Details (${filesCount})</button>
                </div>
              </div>
              <div id="details-${el.id}" class="mt-2 ${isExpanded ? "" : "hidden"}">
                ${filesCount ? el.files.map(f => `
                  <div class='flex items-center justify-between bg-slate-50 border border-slate-200 rounded-md px-2 py-1 mb-1'>
                    <div class='min-w-0 flex-1'>
                      <p class='truncate text-sm text-slate-700' title='${f.name}'>${f.name} • ${(f.size/1024).toFixed(1)} KB ${f.confidential ? "<span class=\"ml-2 text-amber-700 font-semibold\">Confidential</span>" : ""}</p>
                    </div>
                    <div class='flex items-center gap-2'>
                      <button class='px-2 py-1 text-xs bg-white border border-slate-300 rounded hover:bg-slate-50 inline-flex items-center' data-action='view-file' data-id='${el.id}' data-file='${f._id}' title='View' aria-label='View'>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/></svg>
                      </button>
                      <button class='px-2 py-1 text-xs bg-white border border-slate-300 rounded hover:bg-slate-50 inline-flex items-center' data-action='toggle-confidential' data-id='${el.id}' data-file='${f._id}' title='${f.confidential ? 'Unlock' : 'Lock'}' aria-label='${f.confidential ? 'Unlock' : 'Lock'}'>
                        ${f.confidential
                          ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 11V7a5 5 0 0 1 10 0"/><rect width="14" height="10" x="5" y="11" rx="2" ry="2"/></svg>'
                          : '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="10" x="5" y="11" rx="2" ry="2"/><path d="M12 16v2"/><path d="M8 11V7a4 4 0 0 1 8 0v4"/></svg>'}
                      </button>
                      <button class='px-2 py-1 text-xs bg-white border border-red-300 text-red-700 rounded hover:bg-red-50 inline-flex items-center' data-action='remove-file' data-id='${el.id}' data-file='${f._id}' title='Remove' aria-label='Remove'>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>
                      </button>
                    </div>
                  </div>`).join('') : `<div class='text-sm text-slate-500'>No files attached.</div>`}
              </div>
            </td>`;
          tableBody.appendChild(tr);
        });
      });

      // After render: attach events to dynamic parts
      // Phase select and toggle
      tableBody.querySelectorAll('input[data-action="phase-select"]').forEach(cb => {
        if (cb.hasAttribute('indeterminate')) cb.indeterminate = true;
        cb.addEventListener('change', () => {
          const phaseId = +cb.dataset.phase;
          elements.filter(e => e.phase === phaseId).forEach(e => e.selected = cb.checked);
          updateSubmitState();
          render();
        });
      });
      tableBody.querySelectorAll('button[data-action="phase-toggle"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const phaseId = +btn.dataset.phase;
          phaseCollapsed.set(phaseId, !phaseCollapsed.get(phaseId));
          render();
        });
      });

      // Row selects
      tableBody.querySelectorAll('.row-select').forEach(cb => {
        cb.addEventListener('change', () => {
          const id = +cb.dataset.id;
          const el = elements.find(x => x.id === id);
          el.selected = cb.checked;
          updateSubmitState();
        });
      });

      // Dropzones
      tableBody.querySelectorAll('[data-dropzone-id]').forEach(zone => {
        const id = +zone.dataset.dropzoneId;
        const el = elements.find(x => x.id === id);
        attachDropzoneEvents(zone, el);
        // Click to open file picker
        zone.addEventListener('click', (ev) => {
          if (ev.target.closest('button')) return;
          const input = document.getElementById(`file-${id}`);
          input.onchange = () => {
            const files = Array.from(input.files).map(f => ({ file:f, name:f.name, size:f.size, _id:`${Date.now()}-${Math.random().toString(36).slice(2)}`, confidential:false, url: URL.createObjectURL(f) }));
            el.files.push(...files);
            el.status = 'Draft';
            render();
            input.value = '';
          };
          input.click();
        });
      });

      // Buttons (add files / toggle files)
      tableBody.querySelectorAll('button[data-action="add-files"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = +btn.dataset.id;
          const el = elements.find(x => x.id === id);
          const input = document.getElementById(`file-${id}`);
          input.onchange = () => {
            const files = Array.from(input.files).map(f => ({ file:f, name:f.name, size:f.size, _id:`${Date.now()}-${Math.random().toString(36).slice(2)}`, confidential:false, url: URL.createObjectURL(f) }));
            el.files.push(...files);
            el.status = 'Draft';
            render();
            input.value = '';
          }
          input.click();
        });
      });

      tableBody.querySelectorAll('button[data-action="toggle-files"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = +btn.dataset.id;
          if (expandedDetails.has(id)) expandedDetails.delete(id); else expandedDetails.add(id);
          render();
        });
      });

      // File menu actions (delegated)
      

      tableBody.querySelectorAll('[data-action="view-file"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = +btn.dataset.id; const fileId = btn.dataset.file;
          const el = elements.find(x => x.id === id);
          const f = el.files.find(ff => ff._id === fileId);
          if (f?.url) window.open(f.url, '_blank');
        });
      });

      tableBody.querySelectorAll('[data-action="toggle-confidential"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = +btn.dataset.id; const fileId = btn.dataset.file;
          const el = elements.find(x => x.id === id);
          const f = el.files.find(ff => ff._id === fileId);
          if (f) f.confidential = !f.confidential;
          render();
        });
      });

      tableBody.querySelectorAll('[data-action="remove-file"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = +btn.dataset.id; const fileId = btn.dataset.file;
          const el = elements.find(x => x.id === id);
          const f = el.files.find(ff => ff._id === fileId);
          if (f?.url) URL.revokeObjectURL(f.url);
          el.files = el.files.filter(ff => ff._id !== fileId);
          if (el.files.length === 0 && el.status !== 'Submitted') el.status = 'Not Submitted';
          render();
        });
      });

      updateProgress();
      updateSubmitState();
    }

    submitBtn.addEventListener('click', () => {
      const selected = elements.filter(e => e.selected);
      if (selected.some(e => e.files.length === 0)){
        showToast('Cannot submit. Some selected elements have no files.', false);
        return;
      }
      confirmCount.textContent = selected.length;
      confirmModal.classList.remove('hidden');
      confirmModal.classList.add('flex');
    });

    cancelConfirm.addEventListener('click', () => {
      confirmModal.classList.add('hidden');
      confirmModal.classList.remove('flex');
    });

    okConfirm.addEventListener('click', () => {
      const selected = elements.filter(e => e.selected);
      selected.forEach(e => { e.status = 'Submitted'; e.selected = false; });
      render();
      showToast(`Successfully submitted ${selected.length} element(s).`);
      confirmModal.classList.add('hidden');
      confirmModal.classList.remove('flex');
    });

    expandAllBtn.addEventListener('click', () => {
      phases.forEach(p => phaseCollapsed.set(p.id, false));
      render();
    });
    collapseAllBtn.addEventListener('click', () => {
      phases.forEach(p => phaseCollapsed.set(p.id, true));
      render();
    });

    render();
  </script>
</body>
</html>
